<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¶ã„ã™ã½ã£ï¼ã‚³ã‚¹ãƒ—ãƒ¬ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- å¤‰æ•°å®šç¾© (Light/Dark) --- */
        :root { 
            --primary: #5c6ac4; --primary-dark: #4653a1;
            --bg: #f4f6f8; --card-bg: #ffffff; --text: #333; --text-sub: #666;
            --border: #ddd; --modal-bg: rgba(0,0,0,0.85);
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨å¤‰æ•° */
        body.dark-mode {
            --bg: #1a1a2e; --card-bg: #16213e; --text: #e0e0e0; --text-sub: #a0a0a0;
            --border: #2c3e50; --shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; transition: background 0.3s, color 0.3s; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header { background: var(--primary); color: #fff; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        h1 { margin: 0; font-size: 1.4rem; letter-spacing: 1px; }
        
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚¹ã‚¤ãƒƒãƒ */
        .theme-switch { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 1.2rem; transition: 0.3s; }
        .theme-switch:hover { background: rgba(255,255,255,0.4); }

        /* æ¤œç´¢ã¨ãƒ„ãƒ¼ãƒ« */
        .tools-container { max-width: 700px; margin: 15px auto 0; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; align-items: center; }
        .search-input { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; outline: none; min-width: 200px; }
        
        .tool-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; white-space: nowrap; }
        .tool-btn:hover { background: rgba(255,255,255,0.4); }
        .tool-btn.active { background: #fff; color: var(--primary); font-weight: bold; }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        nav { display: flex; justify-content: center; gap: 10px; padding: 20px; }
        .btn-view { background: var(--card-bg); color: var(--primary); border: 1px solid var(--primary); padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn-view.active { background: var(--primary); color: #fff; }
        .btn-view:hover { opacity: 0.8; }

        /* ãƒ¡ã‚¤ãƒ³ */
        main { max-width: 1200px; margin: 0 auto; padding: 0 20px 60px; }
        .section-title { width: 100%; border-bottom: 2px solid var(--border); margin: 40px 0 20px; padding-bottom: 8px; font-size: 1.2rem; color: var(--primary); font-weight: bold; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        
        /* ã‚«ãƒ¼ãƒ‰ */
        .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .card-img-box { width: 100%; height: 250px; background: #333; overflow: hidden; position: relative; }
        .card-img-box img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .card:hover .card-img-box img { transform: scale(1.08); }
        
        .card-info { padding: 12px; }
        .tag-member { display: inline-block; background: #e3f2fd; color: #1565c0; padding: 3px 10px; border-radius: 10px; font-size: 0.75rem; margin-bottom: 5px; }
        .cos-name { font-weight: bold; font-size: 1rem; margin-bottom: 5px; color: var(--text); }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ‹¡å¤§è¡¨ç¤ºï¼‰ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 1000; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal.open { display: flex; opacity: 1; }
        .modal-content { max-width: 90%; max-height: 90%; position: relative; text-align: center; }
        .modal-img { max-width: 100%; max-height: 80vh; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .modal-info { margin-top: 15px; color: #fff; }
        .modal-link-btn { display: inline-block; background: #1da1f2; color: white; padding: 10px 20px; border-radius: 30px; text-decoration: none; margin-top: 10px; font-weight: bold; transition: 0.3s; }
        .modal-link-btn:hover { background: #0c85d0; transform: scale(1.05); }
        .modal-close { position: absolute; top: -40px; right: 0; color: #fff; font-size: 2rem; cursor: pointer; }

        /* ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        #scrollTopBtn { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: #fff; border: none; padding: 15px; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: none; z-index: 90; }
        #scrollTopBtn:hover { transform: scale(1.1); }

    </style>
</head>
<body>

<header>
    <h1>ğŸ‘˜ VSPO! Cosplay Archive</h1>
    <button class="theme-switch" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>

    <div class="tools-container">
        <input type="text" id="searchInput" class="search-input" placeholder="æ¤œç´¢: ã†ã‚‹ã¯ã€â—‹â—‹ã•ã‚“..." oninput="handleSearch()">
        
        <button class="tool-btn active" id="btn-new" onclick="sortData('new')">
            <i class="fas fa-sort-amount-down"></i> æ–°ç€é †
        </button>
        <button class="tool-btn" id="btn-original" onclick="sortData('original')">
            <i class="fas fa-sort-numeric-down"></i> ç™»éŒ²é †
        </button>
        <button class="tool-btn" id="btn-shuffle" onclick="sortData('shuffle')">
            <i class="fas fa-random"></i> ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        </button>
    </div>
</header>

<nav>
    <button class="btn-view active" onclick="switchView('member')">ãƒ¡ãƒ³ãƒãƒ¼åˆ¥</button>
    <button class="btn-view" onclick="switchView('cosplayer')">ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥</button>
</nav>

<main>
    <div id="content-area"></div>
</main>

<button id="scrollTopBtn" onclick="scrollToTop()"><i class="fas fa-arrow-up"></i></button>

<div id="modal" class="modal" onclick="closeModal(event)">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <img id="modalImg" class="modal-img" src="" alt="">
        <div class="modal-info">
            <h3 id="modalTitle"></h3>
            <a id="modalLink" href="#" target="_blank" class="modal-link-btn">
                <i class="fab fa-twitter"></i> å…ƒã®æŠ•ç¨¿ã‚’è¦‹ã‚‹
            </a>
        </div>
    </div>
</div>

<script>
    // â–¼ ã“ã“ã«URLãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„
    const API_URL = "https://script.google.com/macros/s/AKfycbxvb3zcpHRMQDJgq0Ngk92cBG3bXWRMSWVBtKg17CB93xSbuTimDj_5p1Lkq4B5wH2q/exec"; 

    let allData = [];
    let filteredData = [];
    let currentMode = 'member'; 
    let currentSort = 'new';

    // èµ·å‹•æ™‚ã®å‡¦ç†
    fetchData();
    checkTheme();

    async function fetchData() {
        const container = document.getElementById('content-area');
        container.innerHTML = '<p style="text-align:center; padding:50px;">é€šä¿¡ä¸­...</p>';

        try {
            // 1. é€šä¿¡é–‹å§‹ã®ç¢ºèª
            console.log("Fetching data from:", API_URL);
            const res = await fetch(API_URL);

            // 2. é€šä¿¡æˆåŠŸã‹ãƒã‚§ãƒƒã‚¯
            if (!res.ok) {
                alert("ã€ã‚¨ãƒ©ãƒ¼1ã€‘é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: " + res.status);
                throw new Error("Network response was not ok");
            }

            // 3. ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®ãƒã‚§ãƒƒã‚¯
            const data = await res.json();
            
            // è¨ºæ–­ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
            if (!Array.isArray(data)) {
                alert("ã€ã‚¨ãƒ©ãƒ¼2ã€‘ãƒ‡ãƒ¼ã‚¿ãŒã€Œãƒªã‚¹ãƒˆå½¢å¼ã€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\nGASã®ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                container.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼</p>';
                return;
            }

            if (data.length === 0) {
                alert("ã€æ³¨æ„ã€‘ãƒ‡ãƒ¼ã‚¿ã¯å—ã‘å–ã‚Œã¾ã—ãŸãŒã€ä¸­èº«ãŒã€Œ0ä»¶ã€ã§ã™ã€‚\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
            } else {
                // æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šãƒ‡ãƒ¼ã‚¿ã®æœ€åˆã®1ä»¶ã‚’è¡¨ç¤ºã—ã¦ã¿ã‚‹
                const firstItem = JSON.stringify(data[0]);
                // alert("ã€æˆåŠŸï¼ã€‘ãƒ‡ãƒ¼ã‚¿ã‚’ " + data.length + " ä»¶å–å¾—ã—ã¾ã—ãŸã€‚\næœ€åˆã®ãƒ‡ãƒ¼ã‚¿:\n" + firstItem);
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦æç”»
            allData = data;
            // ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã€IDãŒãªã„å ´åˆã¯æ“¬ä¼¼çš„ã«ä»˜ä¸
            allData.forEach((item, index) => {
                if(!item.id) item.id = index;
            });

            sortData('new'); // æç”»å®Ÿè¡Œ

        } catch (e) {
            console.error(e);
            alert("ã€ã‚¨ãƒ©ãƒ¼3ã€‘å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + e.message);
            container.innerHTML = '<p style="text-align:center; color:red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>F12ã‚­ãƒ¼ã®Consoleã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
        }
    }

    // --- ä»¥ä¸‹ã¯ä»¥å‰ã¨åŒã˜è¡¨ç¤ºæ©Ÿèƒ½ ---

    function render() {
        const container = document.getElementById('content-area');
        container.innerHTML = '';
        
        if(filteredData.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#666;">è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        const key = currentMode === 'member' ? 'member' : 'cosplayer';
        const groups = {};
        
        filteredData.forEach(item => {
            if(!item.member) return; // ãƒ¡ãƒ³ãƒãƒ¼åãŒãªã„ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ã‚­ãƒƒãƒ—
            if (!groups[item[key]]) groups[item[key]] = [];
            groups[item[key]].push(item);
        });

        Object.keys(groups).forEach(groupName => {
            const section = document.createElement('div');
            section.innerHTML = `<div class="section-title">â–  ${groupName}</div>`;
            let gridHtml = '<div class="grid">';
            groups[groupName].forEach(item => {
                const safeMember = item.member ? item.member.replace(/'/g, "\\'") : "";
                const safeCos = item.cosplayer ? item.cosplayer.replace(/'/g, "\\'") : "";
                const safeImg = item.image || "";
                const safeLink = item.link || "#";

                gridHtml += `
                    <div class="card" onclick="openModal('${safeImg}', '${safeMember}', '${safeCos}', '${safeLink}')">
                        <div class="card-img-box">
                            <img src="${safeImg}" loading="lazy" alt="cosplay" onerror="this.style.display='none'">
                        </div>
                        <div class="card-info">
                            <span class="tag-member">${item.member}</span>
                            <div class="cos-name">${item.cosplayer}</div>
                        </div>
                    </div>
                `;
            });
            gridHtml += '</div>';
            section.innerHTML += gridHtml;
            container.appendChild(section);
        });
    }

    // å¿…è¦ãªæ©Ÿèƒ½ã ã‘æ®‹ã—ã¦ã„ã¾ã™
    function handleSearch() {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        const keywords = keyword.split(/\s+/);
        filteredData = allData.filter(item => {
            const text = ((item.member||"") + (item.cosplayer||"")).toLowerCase();
            return keywords.every(k => text.includes(k));
        });
        applySort(currentSort);
    }

    function sortData(type) {
        currentSort = type;
        document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
        if(document.getElementById('btn-' + type)) document.getElementById('btn-' + type).classList.add('active');
        applySort(type);
    }

    function applySort(type) {
        if (type === 'new') filteredData.sort((a, b) => b.id - a.id);
        else if (type === 'original') filteredData.sort((a, b) => a.id - b.id);
        else if (type === 'shuffle') filteredData.sort(() => Math.random() - 0.5);
        render();
    }

    function switchView(mode) {
        currentMode = mode;
        document.querySelectorAll('.btn-view').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        render();
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒ†ãƒ¼ãƒç³»
    function openModal(img, member, cosplayer, link) {
        const modal = document.getElementById('modal');
        document.getElementById('modalImg').src = img;
        document.getElementById('modalTitle').innerText = `${member} / ${cosplayer}`;
        document.getElementById('modalLink').href = link;
        modal.classList.add('open');
        document.body.style.overflow = 'hidden'; 
    }
    function closeModal(e) {
        if (e.target.id === 'modal' || e.target.classList.contains('modal-close')) {
            document.getElementById('modal').classList.remove('open');
            document.body.style.overflow = ''; 
        }
    }
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }
    function checkTheme() {
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    }
    window.onscroll = function() {
        const btn = document.getElementById('scrollTopBtn');
        if (btn) btn.style.display = (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) ? "block" : "none";
    };
    function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
</script>

</body>
</html>

